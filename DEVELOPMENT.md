# Development Guide

## Architecture Overview

The app is deployed as:
- **Frontend**: Static files hosted on GitHub Pages (`https://phoenixzqy.github.io/audiobookshelf/`)
- **Backend**: API served via Cloudflare Tunnel (dynamic URL like `https://xxx.trycloudflare.com`)

The frontend loads `config.js` which contains the `tunnelUrl` pointing to the backend.

## Local Development

### Option 1: Local Backend (Default)

Run both frontend and backend locally:

```bash
# Terminal 1: Start backend
cd backend
npm run dev

# Terminal 2: Start frontend
cd frontend
npm run dev
```

Access at: `http://localhost:5173/audiobookshelf/`

The Vite dev server proxies `/api` and `/storage` requests to `http://localhost:8081`.

### Option 2: Remote Backend via Tunnel

Test frontend locally against a remote backend (useful for mobile testing or when backend runs on another machine):

1. **Copy the config template:**
   ```bash
   cd frontend
   cp public/audiobookshelf/config.js.example public/audiobookshelf/config.js
   ```

2. **Edit `config.js` with your tunnel URL:**
   ```javascript
   window.AUDIOBOOKSHELF_CONFIG = {
     tunnelUrl: 'https://your-tunnel-name.trycloudflare.com',
     localUrl: 'http://192.168.1.100:8081',  // Optional: LAN backend URL
     lastUpdated: 'local-dev'
   };
   ```

3. **Start the frontend:**
   ```bash
   npm run dev
   ```

Now API calls go to the tunnel URL instead of the local proxy.

> **Note:** `public/audiobookshelf/config.js` is git-ignored. Only the `.example` file is committed.

## Building for Production

### Automatic Deployment (Recommended)

Simply push changes to the `main` branch. GitHub Actions will automatically:
1. Build the frontend
2. Preserve `config.js` (contains tunnel URL)
3. Deploy to GitHub Pages

The workflow triggers on:
- Changes to `frontend/**`
- Changes to `github-pages/audiobookshelf/config.js`

### Manual Local Build (for testing)

```bash
./scripts/build-for-ghpages.sh
```

This script:
1. Backs up `config.js` (contains current tunnel URL)
2. Cleans the output directory
3. Builds the frontend to `github-pages/audiobookshelf/`
4. Restores `config.js`

Test locally with:
```bash
cd github-pages && npx serve .
```

## Starting the Cloudflare Tunnel

The tunnel script automatically updates `config.js` with the new tunnel URL:

**macOS/Linux:**
```bash
./scripts/start-tunnel.sh
```

**Windows:**
```batch
scripts\start-cloudflare-tunneling.bat
```

After starting the tunnel, rebuild and push to update GitHub Pages with the new URL.

## Project Structure

```
audiobookshelf/
├── frontend/                    # React frontend
│   ├── public/
│   │   └── audiobookshelf/
│   │       └── config.js.example  # Template for local dev config
│   ├── src/
│   │   ├── config/
│   │   │   └── appConfig.ts     # Runtime config loader
│   │   ├── api/
│   │   │   └── client.ts        # Axios client (uses appConfig)
│   │   └── ...
│   └── vite.config.ts           # Build config (base: /audiobookshelf/)
│
├── backend/                     # Express backend
│   └── src/
│       └── app.ts               # CORS configured for GitHub Pages
│
├── github-pages/
│   └── audiobookshelf/          # Production build output
│       ├── config.js            # Auto-generated by tunnel script
│       ├── index.html           # Built by Vite
│       └── assets/              # JS/CSS bundles
│
└── scripts/
    ├── restart-server.bat       # Restart backend server
    ├── start-server.bat         # Start backend server
    ├── stop-server.bat          # Stop backend server
    └── start-cloudflare-tunneling.bat  # Tunnel startup script
```

## URL Structure

| Environment | Frontend URL | API URL |
|-------------|--------------|---------|
| Local Dev (Option 1) | `http://localhost:5173/audiobookshelf/` | `http://localhost:8081/api` (proxied) |
| Local Dev (Option 2) | `http://localhost:5173/audiobookshelf/` | `https://xxx.trycloudflare.com/api` |
| Production (LAN) | `https://phoenixzqy.github.io/audiobookshelf/` | `http://192.168.x.x:8081/api` |
| Production (External) | `https://phoenixzqy.github.io/audiobookshelf/` | `https://xxx.trycloudflare.com/api` |

## LAN-First Connection

The app supports a LAN-first connection strategy to save bandwidth. When `localUrl` is set in `config.js`, the app will:

1. Try to reach the backend via the LAN URL (2-second timeout)
2. If reachable, use LAN for all API and storage requests
3. If not reachable, fall back to the Cloudflare tunnel URL

Set `localUrl` in `github-pages/audiobookshelf/config.js`:
```javascript
window.AUDIOBOOKSHELF_CONFIG = {
  tunnelUrl: 'https://xxx.trycloudflare.com',
  localUrl: 'http://192.168.1.100:8081',
  lastUpdated: '...'
};
```

The connection type (LAN / External / Local Dev) is displayed on the Profile page under Settings.

## Troubleshooting

### Empty page at `/audiobookshelf/`
- Make sure you're accessing `/audiobookshelf/` (with trailing slash) not just `/audiobookshelf`
- Check browser console for errors

### API calls failing in production
- Verify `config.js` exists and contains valid `tunnelUrl`
- Check CORS errors - backend must allow the GitHub Pages origin
- Ensure tunnel is running and URL in `config.js` is current

### Config not loading in dev
- Check that `public/audiobookshelf/config.js` exists (copy from `.example`)
- The file should be served at `/audiobookshelf/config.js`
